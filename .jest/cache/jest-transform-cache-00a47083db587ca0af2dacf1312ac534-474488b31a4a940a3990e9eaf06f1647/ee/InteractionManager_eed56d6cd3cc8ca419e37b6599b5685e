7032a4778a2771b976548949d9f86eb2
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
var _EventEmitter = _interopRequireDefault(require("../vendor/emitter/EventEmitter"));
var BatchedBridge = require("../BatchedBridge/BatchedBridge");
var TaskQueue = require("./TaskQueue");
var infoLog = require("../Utilities/infoLog");
var invariant = require('invariant');
var _emitter = new _EventEmitter.default();
var DEBUG_DELAY = 0;
var DEBUG = false;
var InteractionManager = {
  Events: {
    interactionStart: 'interactionStart',
    interactionComplete: 'interactionComplete'
  },
  runAfterInteractions: function runAfterInteractions(task) {
    var tasks = [];
    var promise = new Promise(function (resolve) {
      _scheduleUpdate();
      if (task) {
        tasks.push(task);
      }
      tasks.push({
        run: resolve,
        name: 'resolve ' + (task && task.name || '?')
      });
      _taskQueue.enqueueTasks(tasks);
    });
    return {
      then: promise.then.bind(promise),
      cancel: function cancel() {
        _taskQueue.cancelTasks(tasks);
      }
    };
  },
  createInteractionHandle: function createInteractionHandle() {
    DEBUG && infoLog('InteractionManager: create interaction handle');
    _scheduleUpdate();
    var handle = ++_inc;
    _addInteractionSet.add(handle);
    return handle;
  },
  clearInteractionHandle: function clearInteractionHandle(handle) {
    DEBUG && infoLog('InteractionManager: clear interaction handle');
    invariant(!!handle, 'InteractionManager: Must provide a handle to clear.');
    _scheduleUpdate();
    _addInteractionSet.delete(handle);
    _deleteInteractionSet.add(handle);
  },
  addListener: _emitter.addListener.bind(_emitter),
  setDeadline: function setDeadline(deadline) {
    _deadline = deadline;
  }
};
var _interactionSet = new Set();
var _addInteractionSet = new Set();
var _deleteInteractionSet = new Set();
var _taskQueue = new TaskQueue({
  onMoreTasks: _scheduleUpdate
});
var _nextUpdateHandle = 0;
var _inc = 0;
var _deadline = -1;
function _scheduleUpdate() {
  if (!_nextUpdateHandle) {
    if (_deadline > 0) {
      _nextUpdateHandle = setTimeout(_processUpdate, 0 + DEBUG_DELAY);
    } else {
      _nextUpdateHandle = setImmediate(_processUpdate);
    }
  }
}
function _processUpdate() {
  _nextUpdateHandle = 0;
  var interactionCount = _interactionSet.size;
  _addInteractionSet.forEach(function (handle) {
    return _interactionSet.add(handle);
  });
  _deleteInteractionSet.forEach(function (handle) {
    return _interactionSet.delete(handle);
  });
  var nextInteractionCount = _interactionSet.size;
  if (interactionCount !== 0 && nextInteractionCount === 0) {
    _emitter.emit(InteractionManager.Events.interactionComplete);
  } else if (interactionCount === 0 && nextInteractionCount !== 0) {
    _emitter.emit(InteractionManager.Events.interactionStart);
  }
  if (nextInteractionCount === 0) {
    while (_taskQueue.hasTasksToProcess()) {
      _taskQueue.processNext();
      if (_deadline > 0 && BatchedBridge.getEventLoopRunningTime() >= _deadline) {
        _scheduleUpdate();
        break;
      }
    }
  }
  _addInteractionSet.clear();
  _deleteInteractionSet.clear();
}
module.exports = InteractionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfRXZlbnRFbWl0dGVyIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJCYXRjaGVkQnJpZGdlIiwiVGFza1F1ZXVlIiwiaW5mb0xvZyIsImludmFyaWFudCIsIl9lbWl0dGVyIiwiRXZlbnRFbWl0dGVyIiwiREVCVUdfREVMQVkiLCJERUJVRyIsIkludGVyYWN0aW9uTWFuYWdlciIsIkV2ZW50cyIsImludGVyYWN0aW9uU3RhcnQiLCJpbnRlcmFjdGlvbkNvbXBsZXRlIiwicnVuQWZ0ZXJJbnRlcmFjdGlvbnMiLCJ0YXNrIiwidGFza3MiLCJwcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJfc2NoZWR1bGVVcGRhdGUiLCJwdXNoIiwicnVuIiwibmFtZSIsIl90YXNrUXVldWUiLCJlbnF1ZXVlVGFza3MiLCJ0aGVuIiwiYmluZCIsImNhbmNlbCIsImNhbmNlbFRhc2tzIiwiY3JlYXRlSW50ZXJhY3Rpb25IYW5kbGUiLCJoYW5kbGUiLCJfaW5jIiwiX2FkZEludGVyYWN0aW9uU2V0IiwiYWRkIiwiY2xlYXJJbnRlcmFjdGlvbkhhbmRsZSIsImRlbGV0ZSIsIl9kZWxldGVJbnRlcmFjdGlvblNldCIsImFkZExpc3RlbmVyIiwic2V0RGVhZGxpbmUiLCJkZWFkbGluZSIsIl9kZWFkbGluZSIsIl9pbnRlcmFjdGlvblNldCIsIlNldCIsIm9uTW9yZVRhc2tzIiwiX25leHRVcGRhdGVIYW5kbGUiLCJzZXRUaW1lb3V0IiwiX3Byb2Nlc3NVcGRhdGUiLCJzZXRJbW1lZGlhdGUiLCJpbnRlcmFjdGlvbkNvdW50Iiwic2l6ZSIsImZvckVhY2giLCJuZXh0SW50ZXJhY3Rpb25Db3VudCIsImVtaXQiLCJoYXNUYXNrc1RvUHJvY2VzcyIsInByb2Nlc3NOZXh0IiwiZ2V0RXZlbnRMb29wUnVubmluZ1RpbWUiLCJjbGVhciIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJJbnRlcmFjdGlvbk1hbmFnZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmb3JtYXRcbiAqIEBmbG93IHN0cmljdC1sb2NhbFxuICovXG5cbmNvbnN0IEJhdGNoZWRCcmlkZ2UgPSByZXF1aXJlKCcuLi9CYXRjaGVkQnJpZGdlL0JhdGNoZWRCcmlkZ2UnKTtcbmNvbnN0IFRhc2tRdWV1ZSA9IHJlcXVpcmUoJy4vVGFza1F1ZXVlJyk7XG5cbmNvbnN0IGluZm9Mb2cgPSByZXF1aXJlKCcuLi9VdGlsaXRpZXMvaW5mb0xvZycpO1xuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnaW52YXJpYW50Jyk7XG5cbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnLi4vdmVuZG9yL2VtaXR0ZXIvRXZlbnRFbWl0dGVyJztcblxuZXhwb3J0IHR5cGUgSGFuZGxlID0gbnVtYmVyO1xuaW1wb3J0IHR5cGUge1Rhc2t9IGZyb20gJy4vVGFza1F1ZXVlJztcblxuY29uc3QgX2VtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPHtcbiAgaW50ZXJhY3Rpb25Db21wbGV0ZTogW10sXG4gIGludGVyYWN0aW9uU3RhcnQ6IFtdLFxufT4oKTtcblxuY29uc3QgREVCVUdfREVMQVk6IDAgPSAwO1xuY29uc3QgREVCVUc6IGZhbHNlID0gZmFsc2U7XG5cbi8qKlxuICogSW50ZXJhY3Rpb25NYW5hZ2VyIGFsbG93cyBsb25nLXJ1bm5pbmcgd29yayB0byBiZSBzY2hlZHVsZWQgYWZ0ZXIgYW55XG4gKiBpbnRlcmFjdGlvbnMvYW5pbWF0aW9ucyBoYXZlIGNvbXBsZXRlZC4gSW4gcGFydGljdWxhciwgdGhpcyBhbGxvd3MgSmF2YVNjcmlwdFxuICogYW5pbWF0aW9ucyB0byBydW4gc21vb3RobHkuXG4gKlxuICogQXBwbGljYXRpb25zIGNhbiBzY2hlZHVsZSB0YXNrcyB0byBydW4gYWZ0ZXIgaW50ZXJhY3Rpb25zIHdpdGggdGhlIGZvbGxvd2luZzpcbiAqXG4gKiBgYGBcbiAqIEludGVyYWN0aW9uTWFuYWdlci5ydW5BZnRlckludGVyYWN0aW9ucygoKSA9PiB7XG4gKiAgIC8vIC4uLmxvbmctcnVubmluZyBzeW5jaHJvbm91cyB0YXNrLi4uXG4gKiB9KTtcbiAqIGBgYFxuICpcbiAqIENvbXBhcmUgdGhpcyB0byBvdGhlciBzY2hlZHVsaW5nIGFsdGVybmF0aXZlczpcbiAqXG4gKiAtIHJlcXVlc3RBbmltYXRpb25GcmFtZSgpOiBmb3IgY29kZSB0aGF0IGFuaW1hdGVzIGEgdmlldyBvdmVyIHRpbWUuXG4gKiAtIHNldEltbWVkaWF0ZS9zZXRUaW1lb3V0KCk6IHJ1biBjb2RlIGxhdGVyLCBub3RlIHRoaXMgbWF5IGRlbGF5IGFuaW1hdGlvbnMuXG4gKiAtIHJ1bkFmdGVySW50ZXJhY3Rpb25zKCk6IHJ1biBjb2RlIGxhdGVyLCB3aXRob3V0IGRlbGF5aW5nIGFjdGl2ZSBhbmltYXRpb25zLlxuICpcbiAqIFRoZSB0b3VjaCBoYW5kbGluZyBzeXN0ZW0gY29uc2lkZXJzIG9uZSBvciBtb3JlIGFjdGl2ZSB0b3VjaGVzIHRvIGJlIGFuXG4gKiAnaW50ZXJhY3Rpb24nIGFuZCB3aWxsIGRlbGF5IGBydW5BZnRlckludGVyYWN0aW9ucygpYCBjYWxsYmFja3MgdW50aWwgYWxsXG4gKiB0b3VjaGVzIGhhdmUgZW5kZWQgb3IgYmVlbiBjYW5jZWxsZWQuXG4gKlxuICogSW50ZXJhY3Rpb25NYW5hZ2VyIGFsc28gYWxsb3dzIGFwcGxpY2F0aW9ucyB0byByZWdpc3RlciBhbmltYXRpb25zIGJ5XG4gKiBjcmVhdGluZyBhbiBpbnRlcmFjdGlvbiAnaGFuZGxlJyBvbiBhbmltYXRpb24gc3RhcnQsIGFuZCBjbGVhcmluZyBpdCB1cG9uXG4gKiBjb21wbGV0aW9uOlxuICpcbiAqIGBgYFxuICogdmFyIGhhbmRsZSA9IEludGVyYWN0aW9uTWFuYWdlci5jcmVhdGVJbnRlcmFjdGlvbkhhbmRsZSgpO1xuICogLy8gcnVuIGFuaW1hdGlvbi4uLiAoYHJ1bkFmdGVySW50ZXJhY3Rpb25zYCB0YXNrcyBhcmUgcXVldWVkKVxuICogLy8gbGF0ZXIsIG9uIGFuaW1hdGlvbiBjb21wbGV0aW9uOlxuICogSW50ZXJhY3Rpb25NYW5hZ2VyLmNsZWFySW50ZXJhY3Rpb25IYW5kbGUoaGFuZGxlKTtcbiAqIC8vIHF1ZXVlZCB0YXNrcyBydW4gaWYgYWxsIGhhbmRsZXMgd2VyZSBjbGVhcmVkXG4gKiBgYGBcbiAqXG4gKiBgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgIHRha2VzIGVpdGhlciBhIHBsYWluIGNhbGxiYWNrIGZ1bmN0aW9uLCBvciBhXG4gKiBgUHJvbWlzZVRhc2tgIG9iamVjdCB3aXRoIGEgYGdlbmAgbWV0aG9kIHRoYXQgcmV0dXJucyBhIGBQcm9taXNlYC4gIElmIGFcbiAqIGBQcm9taXNlVGFza2AgaXMgc3VwcGxpZWQsIHRoZW4gaXQgaXMgZnVsbHkgcmVzb2x2ZWQgKGluY2x1ZGluZyBhc3luY2hyb25vdXNcbiAqIGRlcGVuZGVuY2llcyB0aGF0IGFsc28gc2NoZWR1bGUgbW9yZSB0YXNrcyB2aWEgYHJ1bkFmdGVySW50ZXJhY3Rpb25zYCkgYmVmb3JlXG4gKiBzdGFydGluZyBvbiB0aGUgbmV4dCB0YXNrIHRoYXQgbWlnaHQgaGF2ZSBiZWVuIHF1ZXVlZCB1cCBzeW5jaHJvbm91c2x5XG4gKiBlYXJsaWVyLlxuICpcbiAqIEJ5IGRlZmF1bHQsIHF1ZXVlZCB0YXNrcyBhcmUgZXhlY3V0ZWQgdG9nZXRoZXIgaW4gYSBsb29wIGluIG9uZVxuICogYHNldEltbWVkaWF0ZWAgYmF0Y2guIElmIGBzZXREZWFkbGluZWAgaXMgY2FsbGVkIHdpdGggYSBwb3NpdGl2ZSBudW1iZXIsIHRoZW5cbiAqIHRhc2tzIHdpbGwgb25seSBiZSBleGVjdXRlZCB1bnRpbCB0aGUgZGVhZGxpbmUgKGluIHRlcm1zIG9mIGpzIGV2ZW50IGxvb3AgcnVuXG4gKiB0aW1lKSBhcHByb2FjaGVzLCBhdCB3aGljaCBwb2ludCBleGVjdXRpb24gd2lsbCB5aWVsZCB2aWEgc2V0VGltZW91dCxcbiAqIGFsbG93aW5nIGV2ZW50cyBzdWNoIGFzIHRvdWNoZXMgdG8gc3RhcnQgaW50ZXJhY3Rpb25zIGFuZCBibG9jayBxdWV1ZWQgdGFza3NcbiAqIGZyb20gZXhlY3V0aW5nLCBtYWtpbmcgYXBwcyBtb3JlIHJlc3BvbnNpdmUuXG4gKi9cbmNvbnN0IEludGVyYWN0aW9uTWFuYWdlciA9IHtcbiAgRXZlbnRzOiB7XG4gICAgaW50ZXJhY3Rpb25TdGFydDogJ2ludGVyYWN0aW9uU3RhcnQnLFxuICAgIGludGVyYWN0aW9uQ29tcGxldGU6ICdpbnRlcmFjdGlvbkNvbXBsZXRlJyxcbiAgfSxcblxuICAvKipcbiAgICogU2NoZWR1bGUgYSBmdW5jdGlvbiB0byBydW4gYWZ0ZXIgYWxsIGludGVyYWN0aW9ucyBoYXZlIGNvbXBsZXRlZC4gUmV0dXJucyBhIGNhbmNlbGxhYmxlXG4gICAqIFwicHJvbWlzZVwiLlxuICAgKi9cbiAgcnVuQWZ0ZXJJbnRlcmFjdGlvbnModGFzazogP1Rhc2spOiB7XG4gICAgdGhlbjogPFU+KFxuICAgICAgb25GdWxmaWxsPzogPyh2b2lkKSA9PiA/KFByb21pc2U8VT4gfCBVKSxcbiAgICAgIG9uUmVqZWN0PzogPyhlcnJvcjogbWl4ZWQpID0+ID8oUHJvbWlzZTxVPiB8IFUpLFxuICAgICkgPT4gUHJvbWlzZTxVPixcbiAgICBjYW5jZWw6ICgpID0+IHZvaWQsXG4gICAgLi4uXG4gIH0ge1xuICAgIGNvbnN0IHRhc2tzOiBBcnJheTxUYXNrPiA9IFtdO1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZTogKCkgPT4gdm9pZCkgPT4ge1xuICAgICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgICBpZiAodGFzaykge1xuICAgICAgICB0YXNrcy5wdXNoKHRhc2spO1xuICAgICAgfVxuICAgICAgdGFza3MucHVzaCh7XG4gICAgICAgIHJ1bjogcmVzb2x2ZSxcbiAgICAgICAgbmFtZTogJ3Jlc29sdmUgJyArICgodGFzayAmJiB0YXNrLm5hbWUpIHx8ICc/JyksXG4gICAgICB9KTtcbiAgICAgIF90YXNrUXVldWUuZW5xdWV1ZVRhc2tzKHRhc2tzKTtcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgLy8gJEZsb3dGaXhNZVttZXRob2QtdW5iaW5kaW5nXSBhZGRlZCB3aGVuIGltcHJvdmluZyB0eXBpbmcgZm9yIHRoaXMgcGFyYW1ldGVyc1xuICAgICAgdGhlbjogcHJvbWlzZS50aGVuLmJpbmQocHJvbWlzZSksXG4gICAgICBjYW5jZWw6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgX3Rhc2tRdWV1ZS5jYW5jZWxUYXNrcyh0YXNrcyk7XG4gICAgICB9LFxuICAgIH07XG4gIH0sXG5cbiAgLyoqXG4gICAqIE5vdGlmeSBtYW5hZ2VyIHRoYXQgYW4gaW50ZXJhY3Rpb24gaGFzIHN0YXJ0ZWQuXG4gICAqL1xuICBjcmVhdGVJbnRlcmFjdGlvbkhhbmRsZSgpOiBIYW5kbGUge1xuICAgIERFQlVHICYmIGluZm9Mb2coJ0ludGVyYWN0aW9uTWFuYWdlcjogY3JlYXRlIGludGVyYWN0aW9uIGhhbmRsZScpO1xuICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgIGNvbnN0IGhhbmRsZSA9ICsrX2luYztcbiAgICBfYWRkSW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSk7XG4gICAgcmV0dXJuIGhhbmRsZTtcbiAgfSxcblxuICAvKipcbiAgICogTm90aWZ5IG1hbmFnZXIgdGhhdCBhbiBpbnRlcmFjdGlvbiBoYXMgY29tcGxldGVkLlxuICAgKi9cbiAgY2xlYXJJbnRlcmFjdGlvbkhhbmRsZShoYW5kbGU6IEhhbmRsZSkge1xuICAgIERFQlVHICYmIGluZm9Mb2coJ0ludGVyYWN0aW9uTWFuYWdlcjogY2xlYXIgaW50ZXJhY3Rpb24gaGFuZGxlJyk7XG4gICAgaW52YXJpYW50KCEhaGFuZGxlLCAnSW50ZXJhY3Rpb25NYW5hZ2VyOiBNdXN0IHByb3ZpZGUgYSBoYW5kbGUgdG8gY2xlYXIuJyk7XG4gICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgX2FkZEludGVyYWN0aW9uU2V0LmRlbGV0ZShoYW5kbGUpO1xuICAgIF9kZWxldGVJbnRlcmFjdGlvblNldC5hZGQoaGFuZGxlKTtcbiAgfSxcblxuICAvLyAkRmxvd0ZpeE1lW21ldGhvZC11bmJpbmRpbmddIGFkZGVkIHdoZW4gaW1wcm92aW5nIHR5cGluZyBmb3IgdGhpcyBwYXJhbWV0ZXJzXG4gIGFkZExpc3RlbmVyOiAoX2VtaXR0ZXIuYWRkTGlzdGVuZXIuYmluZChfZW1pdHRlcik6ICRGbG93Rml4TWUpLFxuXG4gIC8qKlxuICAgKiBBIHBvc2l0aXZlIG51bWJlciB3aWxsIHVzZSBzZXRUaW1lb3V0IHRvIHNjaGVkdWxlIGFueSB0YXNrcyBhZnRlciB0aGVcbiAgICogZXZlbnRMb29wUnVubmluZ1RpbWUgaGl0cyB0aGUgZGVhZGxpbmUgdmFsdWUsIG90aGVyd2lzZSBhbGwgdGFza3Mgd2lsbCBiZVxuICAgKiBleGVjdXRlZCBpbiBvbmUgc2V0SW1tZWRpYXRlIGJhdGNoIChkZWZhdWx0KS5cbiAgICovXG4gIHNldERlYWRsaW5lKGRlYWRsaW5lOiBudW1iZXIpIHtcbiAgICBfZGVhZGxpbmUgPSBkZWFkbGluZTtcbiAgfSxcbn07XG5cbmNvbnN0IF9pbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF9hZGRJbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF9kZWxldGVJbnRlcmFjdGlvblNldCA9IG5ldyBTZXQoKTtcbmNvbnN0IF90YXNrUXVldWUgPSBuZXcgVGFza1F1ZXVlKHtvbk1vcmVUYXNrczogX3NjaGVkdWxlVXBkYXRlfSk7XG5sZXQgX25leHRVcGRhdGVIYW5kbGU6ICRGbG93Rml4TWUgfCBUaW1lb3V0SUQgPSAwO1xubGV0IF9pbmMgPSAwO1xubGV0IF9kZWFkbGluZSA9IC0xO1xuXG4vKipcbiAqIFNjaGVkdWxlIGFuIGFzeW5jaHJvbm91cyB1cGRhdGUgdG8gdGhlIGludGVyYWN0aW9uIHN0YXRlLlxuICovXG5mdW5jdGlvbiBfc2NoZWR1bGVVcGRhdGUoKSB7XG4gIGlmICghX25leHRVcGRhdGVIYW5kbGUpIHtcbiAgICBpZiAoX2RlYWRsaW5lID4gMCkge1xuICAgICAgX25leHRVcGRhdGVIYW5kbGUgPSBzZXRUaW1lb3V0KF9wcm9jZXNzVXBkYXRlLCAwICsgREVCVUdfREVMQVkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBfbmV4dFVwZGF0ZUhhbmRsZSA9IHNldEltbWVkaWF0ZShfcHJvY2Vzc1VwZGF0ZSk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogTm90aWZ5IGxpc3RlbmVycywgcHJvY2VzcyBxdWV1ZSwgZXRjXG4gKi9cbmZ1bmN0aW9uIF9wcm9jZXNzVXBkYXRlKCkge1xuICBfbmV4dFVwZGF0ZUhhbmRsZSA9IDA7XG5cbiAgY29uc3QgaW50ZXJhY3Rpb25Db3VudCA9IF9pbnRlcmFjdGlvblNldC5zaXplO1xuICBfYWRkSW50ZXJhY3Rpb25TZXQuZm9yRWFjaChoYW5kbGUgPT4gX2ludGVyYWN0aW9uU2V0LmFkZChoYW5kbGUpKTtcbiAgX2RlbGV0ZUludGVyYWN0aW9uU2V0LmZvckVhY2goaGFuZGxlID0+IF9pbnRlcmFjdGlvblNldC5kZWxldGUoaGFuZGxlKSk7XG4gIGNvbnN0IG5leHRJbnRlcmFjdGlvbkNvdW50ID0gX2ludGVyYWN0aW9uU2V0LnNpemU7XG5cbiAgaWYgKGludGVyYWN0aW9uQ291bnQgIT09IDAgJiYgbmV4dEludGVyYWN0aW9uQ291bnQgPT09IDApIHtcbiAgICAvLyB0cmFuc2l0aW9uIGZyb20gMSsgLS0+IDAgaW50ZXJhY3Rpb25zXG4gICAgX2VtaXR0ZXIuZW1pdChJbnRlcmFjdGlvbk1hbmFnZXIuRXZlbnRzLmludGVyYWN0aW9uQ29tcGxldGUpO1xuICB9IGVsc2UgaWYgKGludGVyYWN0aW9uQ291bnQgPT09IDAgJiYgbmV4dEludGVyYWN0aW9uQ291bnQgIT09IDApIHtcbiAgICAvLyB0cmFuc2l0aW9uIGZyb20gMCAtLT4gMSsgaW50ZXJhY3Rpb25zXG4gICAgX2VtaXR0ZXIuZW1pdChJbnRlcmFjdGlvbk1hbmFnZXIuRXZlbnRzLmludGVyYWN0aW9uU3RhcnQpO1xuICB9XG5cbiAgLy8gcHJvY2VzcyB0aGUgcXVldWUgcmVnYXJkbGVzcyBvZiBhIHRyYW5zaXRpb25cbiAgaWYgKG5leHRJbnRlcmFjdGlvbkNvdW50ID09PSAwKSB7XG4gICAgd2hpbGUgKF90YXNrUXVldWUuaGFzVGFza3NUb1Byb2Nlc3MoKSkge1xuICAgICAgX3Rhc2tRdWV1ZS5wcm9jZXNzTmV4dCgpO1xuICAgICAgaWYgKFxuICAgICAgICBfZGVhZGxpbmUgPiAwICYmXG4gICAgICAgIEJhdGNoZWRCcmlkZ2UuZ2V0RXZlbnRMb29wUnVubmluZ1RpbWUoKSA+PSBfZGVhZGxpbmVcbiAgICAgICkge1xuICAgICAgICAvLyBIaXQgZGVhZGxpbmUgYmVmb3JlIHByb2Nlc3NpbmcgYWxsIHRhc2tzLCBzbyBwcm9jZXNzIG1vcmUgbGF0ZXIuXG4gICAgICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgX2FkZEludGVyYWN0aW9uU2V0LmNsZWFyKCk7XG4gIF9kZWxldGVJbnRlcmFjdGlvblNldC5jbGVhcigpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEludGVyYWN0aW9uTWFuYWdlcjtcbiJdLCJtYXBwaW5ncyI6Ijs7O0FBZ0JBLElBQUFBLGFBQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQU5BLElBQU1DLGFBQWEsR0FBR0QsT0FBTyxrQ0FBa0M7QUFDL0QsSUFBTUUsU0FBUyxHQUFHRixPQUFPLGVBQWU7QUFFeEMsSUFBTUcsT0FBTyxHQUFHSCxPQUFPLHdCQUF3QjtBQUMvQyxJQUFNSSxTQUFTLEdBQUdKLE9BQU8sQ0FBQyxXQUFXLENBQUM7QUFPdEMsSUFBTUssUUFB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